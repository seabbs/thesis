---
output:
  html_document: default
  pdf_document: default
  word_document: default
---

# Developing a dynamic transmission model of Tuberculosis {#model-development}


```{r model-devel-setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dpi = 320, 
                      fig.width = 8, fig.height = 8,
                      out.width = "80%", fig.align = 'center')

## Wordcount: 11105
##packages
library(tidyverse)
library(kableExtra)
library(pander)
## Resources path
resources_path <- file.path("chapters", "model-development")

## Read data: https://github.com/seabbs/ModelTBBCGEngland/data
load_formated <- function(name) {

  path <- file.path("chapters/model-development/data", paste0(name, ".rda"))
  
  load(path, envir = globalenv())
}

load_formated("disease_params_table")
load_formated("demographic_params_table")
load_formated("sources_table")
load_formated("scenarios_table")
load_formated("eff_bcg")
```

## Introduction

In the previous chapter (Chapter \@ref(direct-eff)) I estimated the impact of the change in BCG policy on the subset of the population who were directly impacted. Unfortunately, the time horizon of this estimate was limited by the available data. Additionallly, if there is a non-negligible amount of Tuberculosis (TB) transmission amongst the UK born then any change in BCG vaccination policy will also have in-direct impacts, via on-wards transmission, not captured in this estimate. Both of these limitations can be over come using a dynamic transmission model (see Chapter \@ref(introduction)), this explicitly models the rate that individuals are infected using the mass action assumption.[@Anderson1991; @Keeling2007] A dynamic transmission model also allows estimates to be made of the long term impact of BCG policy changes, via model simulation.

This chapter presents the development and parameterisation of a, semi-stochastic, dynamic model of TB transmission, incorporating BCG vaccination, in the UK born population of England. The key features of TB transmission, and BCG vaccination, are discussed with details of pertinent TB models given. An appropriate model structure for answering the study question is then outlined, along with a justification of the choices made and details of required sensitivity analyses. The model structure is then defined mathematically and parameterised using literature sources as well as data from the Enhanced TB Surveillance System (ETS), Labour Force Survey (LFS) and Office for National Statistics (ONS) (see Chapter \@ref(data)). The assumptions made during model building and parameterisation are highlighted in preparation for evaluation during model fitting (Chapter \@ref(model-fitting)).

## Choice of model structure {#model-just}

When developing an infectious disease dynamic model there is a trade-off between reproducing reality and interpretability.[@Anderson1991] A model that includes all known features of a disease may not be able to answer questions of interest as it is too complex to interpret or because data does not exist to calibrate many of its parameters. A highly complex model, or indeed an overly simplistic one, may also be at risk of bias. The optimal model is therefore as parsimonious as possible, whilst still capturing the key features of a disease and making best use of all available data.[@Anderson1991] In this section the key features of TB, and BCG vaccination, that must be captured in order to produce meaningful output are discussed, as well as the features that can be excluded for this study question. Data from the ETS (Chapter \@ref(data)) is used to support evidence from the literature. Further background information can be found in Chapter \@ref(background) and Chapter \@ref(data). 

### TB disease

The key features of TB transmission in England which must be captured in order to develop a methodologically sound model, are as follows:

1. **Latency** - after an initial infection 5-10% of individuals develop symptomatic TB within 1-2 years. The majority of individuals enter a latent state in which they passively carry TB mycobacterium but are not symptomatic. Reactivation of the bacilli can then occur many years later due to a lose of immune control.[@Gideon2011a] Simplistically latent TB may be modeled with a single latent compartment[@Brooks-Pollock2010a], more commonly an additional transition rate between the susceptible and active disease states is added.[@Menzies2018] This represents rapid progression to active disease, and slower progression via a low risk latent stage. Both of these model structures have been shown to not fit activation data well.[@Menzies2018; @Ragonnet2017] More complex structures that are commonly used incorporate either parallel or serial latency (Figure \@ref(fig:latency-flow-diag)). Both of these structures incorporate both slow and fast latent periods and have been shown to produce identical activation dynamics.[@Ragonnet2017] This is unfortunate as they represent two disparate biological mechanisms, with the serial assumption representing decreasing risk over time for individuals and the parallel assumption suggesting that a subset of individuals are at a greater risk of developing active TB disease. For models that seek to investigate interventions targeted at latent cases this structural uncertainty is problematic. However, as BCG vaccination occurs prior to infection both structures will produce comparable results for study questions evaluating this intervention. The model presented here uses a serial latent structure. This is commonly used in the literature; simplifies modelling other aspects of TB; and has a plausible biological underpinning.[@Ragonnet2017]

\newpage

```{r latency-flow-diag, out.width = "200px", fig.scap = "Flow diagrams of a.) the serial latency assumption and b.) the parallel latency assumption.", fig.cap = "Flow diagrams of a.) the serial latency assumption and b.) the parallel latency assumption. The flow diagrams contain the following compartments; Susceptible ($S$), high risk latent ($H$), low risk latent ($L$), and infected ($I$). Solid arrows represent transition rates. Note that in both models repeated transmission to low risk latents is possible. This allows low risk latent cases to become high risk latent cases. For some varients of the parallel latency assumption, where it is assumed being high risk is inherent to individuals, this may not be appropriate.", out.extra = ""}
knitr::include_graphics(file.path(resources_path, "resources", "model_diagrams", "latency_flow.png"))
```
    
1. **Pulmonary/Extra-Pulmonary TB** - active TB disease can be defined as any symptomatic TB infection but it may present with a range of diverse individual states. Commonly, TB cases are stratified into pulmonary and extra-pulmonary TB cases, with pulmonary cases being individuals who present with TB present in the lungs, and extra-pulmonary TB cases being cases that present with TB symptoms that do not involve the lungs (Chapter \@ref(background)). Often pulmonary cases also present with extra-pulmonary symptoms. It is thought that pulmonary TB cases make up for the vast majority of TB transmission,[@Mathema2018; @Sepkowitz1996] as TB is primarily spread by aerosol transmission, but that extra-pulmonary cases have worse outcomes. The proportion of pulmonary to extra-pulmonary cases has increased over time from 26.2% (1944/7410) in 1982 to 45.8% (2634/5748) in 2016. This may be attributed to the age distribution of TB cases changing, as different age-groups are more likely to progress to pulmonary vs extra-pulmonary TB.[@Lefebvre2017] It may also be related to the increase of non-UK born cases, as a higher proportion of non-UK born cases have extra-pulmonary disease only (51.4%, 2,103/4,089, in 2016), compared to UK born cases (31.9%, 467/1,465, in 2016).[@PHE2017] The model presented here includes both pulmonary and extra-pulmonary cases, with only pulmonary cases contributing to onwards transmission. Extra-pulmonary cases are included so that the full impacts of any intervention can be correctly estimated.

1. **Smear status** - microscopic analysis of sputum smear samples for acid-fast bacilli is widely used as a means of diagnosis for TB. There is evidence that smear positive cases are responsible for the majority of transmission,[@PMID:13148535] with smear negative cases contributing approximately 76% (95% CI 70%, 80%) less to transmission than smear positive cases.[@Tostmann2008] The proportion of smear positive cases varies with age,[@Piccini2014] with 30.2% (95% CI 26.3%, 33.7%) in 0-14 year-olds, 65.2% (95% CI 64.2%, 66.2%) in 15-59 year-olds and 53.6% (95% CI 51.9%, 55.3%) in 60-89 year-olds in the ETS between 2000 and 2015. the model presented here includes sputum status via the force of infection.[@Anderson1991; @Keeling2007]

1. **Re-infection** - individuals with latent TB, or who have recovered from active TB, may be at risk of re-infection. It is thought that latent individuals gain some partial protection from prior infection but estimates for the magnitude of this protection vary widely.[@Houben2016] A review of prospective cohort studies of persons exposed to individuals with infectious TB that was published prior to the widespread treatment of latent TB found that prior TB infection provided partial protection of 79% (70%, 86%).[@Andrews2012] This is included in the model presented below via a the force of infection.

1. **Re-activation/Re-infection of recovered cases** - individuals who have recovered from active TB disease are at risk of both re-infection and re-activation. As in many dynamic transmission models, this has been modelled here by treating recovered cases as having low risk latent TB.[@Vynnycky1997; @Houben2016a] This provides recovered cases with the same protection against re-infection as low risk latent cases. However, this means that vaccinated cases receive the benefits of BCG protection even after they have recovered from active TB disease.This may not be realistic but due to the low burden of TB in England is unlikely to lead to significant bias. 

1. **TB treatment** - standard treatment consists of a 6 month course of multiple antibiotics, usually consisting of isoniazid, rifampicin, pyrazinamide and ethambutol. If treatment is unsuccessful using these first line drugs, second line drugs are then proscribed which have more severe side effects and a longer treatment regime (12-24 months).[@WHOTB2016; @PHE2017] Individuals on treatment may be considered non-infectious but are still at risk of negative outcomes including death. 4.9% (4847/98124) of cases in the ETS were lost to follow up within the first year of starting treatment between 2000 and 2014. A treatment term has been included in the model presented here along with potential treatment failure. Multi-stage treatment has not been modelled as this would add complexity but would not improve the models performance in other areas.


1. **TB related mortality** - within the first 12 months of starting treatment 6% (5884/98124) of cases, with complete data and who were evaluated, died in the ETS between 2000 and 2014. Of these 60.5% (1984/3290) had TB as a cause of death or had a cause of death that was related to active TB. The rate of TB mortality varies with age, with the very old and the very young at the greatest risk. Age-stratified TB mortality is important to include in any policy relevant model of TB transmission as reducing mortality is a major public health goal. There is little data on the rate of TB mortality in those untreated for TB, so all TB mortality will be modelled using a single, age stratified, term.

1. **Age related presentation of TB** - there is evidence to suggest that the risk of TB activation varies by age,[@Ragonnet2017] as does the proportion of cases that develop pulmonary TB,[@Lefebvre2017], the proportion of cases that are smear positive, and the risk of TB mortality. It may also be the case that the transmission probability varies by age, after accounting for the proportion of cases that are pulmonary and the proportion of cases that are smear positive. In the model presented here age has been included by stratifying the population into age-groups.
    
1. **Demographic changes** - TB dynamics develop over a long timespan, because of the potential for cases to develop active TB disease many years after infection. Over these long timespans population demographics can play an important role. An approach to include demographics is to link birth and death rates so that the modeled population is static over time. This has the advantage of making it easier to identify changes that are linked to the disease dynamics. In the model presented here birth and death processes have been incorporated based on available, age-specific, data. For years with available data this has the advantage of producing demographics which match those observed in the study population, allowing for policy relevant forecasts to be made. However, for years with limited data assumptions must be made about the likely birth and death rates (see \@ref(demo-model-parameters)). 

1. **Non-UK born TB Cases** - TB incidence in England is highly heterogeneous with over 70% of cases occurring in the non-UK born population.[@PHE2017] The age distribution of cases in the UK born and non-UK born populations differ, with the UK born population having a relatively uniform distribution. Meanwhile, the non-UK born have higher incidence rates in those aged 80 years and older (69.3 per 100,000 in 2016), those aged 75-79 years old (62.9 per 100,000 in 2016) and those aged 25-29 years old (61.6 per 100,000 in 2016).[@PHE2017] Exposure to England's BCG vaccination policy is difficult to assess for the non-UK born as is the degree of transmission occurring in the UK as opposed to cases being imported from abroad, or acquired from trips to cases countries of origin. For this reason the model presented here does not explicitly include non-UK born cases. Instead it imports non-UK born cases into the force of infection with a mixing parameter that controls the degree of contact between non-UK born cases and those born in the UK.[@Anderson1991; @Keeling2007]


### BCG vaccination

The key features of the BCG vaccine that must be considered in order to forecast the impacts of vaccine policy are:

1. **Protection from active disease** - the BCG vaccine has been shown to primarily protect against the progression from latent to active TB disease (Chapter \@ref(background)). It has been shown to be highly protective in children[@Rodrigues1993; @Colditz1994; @Roy2014] but to have variable protection in adults ranging from 0-80%.[Mangtani2014; @Zwerling2011] This variation in protection is thought to be linked to the equator with the vaccine becoming increasing effective at higher, and lower latitudes. In England, an MRC trial in the 1950's found that the BCG vaccine was highly effective.[@Hart1972] There is little evidence to suggest that this has changed in the UK born population.
    
1. **Duration of protection** - BCG protection wanes with time, with the greatest protection shortly after vaccination. There is good evidence to suggest that the effectiveness of BCG vaccination lasts up to 15 years,[@Abubakar2013] and a recent study suggests that this protection may last later into adulthood in the UK born.[@Mangtani2017]

1. **Protection from initial infection** -  there is evidence that the BCG vaccine provides partial protection against initial infection.[@Roy2014] This may impact transmission dynamics. Not including it would lead to a higher proportion of latent cases in those vaccinated with BCG. One complicating factor is that the majority of the estimates of the protection offered by BCG vaccination from active TB disease include the protection from initial infection. 
    
1. **Age structure** - BCG vaccination has previously been targeted at those at school-age and is currently targeted at neonates. There is also evidence that the effectiveness of BCG vaccination varies with age,[@Rodrigues1993, @Colditz1994; @Mangtani2014a] although there is little evidence of this in England. In order to answer questions relevant to BCG vaccination, TB disease must be modeled in young children and young adults. To capture the waning of BCG protection age structure must be modeled beyond these age groups.[@Abubakar2013] 

1. **Non-UK born TB Cases** - the majority of cases that occur in the non-UK born would not have been exposed to England's BCG vaccination. In the majority of high incidence countries BCG vaccination is common, with most countries vaccinating young children as early in life as possible.[@Zwerling2011a] Based on this it could be assumed that all non-UK born cases were vaccinated at birth. However, this high level of coverage is unlikely. As the BCG vaccine has not been shown to decrease the likelihood of transmission from vaccinated TB cases assuming that all non-UK born cases are unvaccinated does not impact the dynamics in the modeled UK born population. 

1. **Additional benefits of BCG vaccination** - there is some evidence that the BCG vaccine may reduce all-cause mortality both in the general population and specifically for TB cases (Chapter \@ref(beneficial-bcg-out)). There is weaker evidence that this reduction in all-cause mortality for TB cases may be associated with a reduction in TB specific mortality. This was not included in the model presented here as the evidence was not conclusive. This means the benefits of the BCG vaccine may have been underestimated.
    
## A dynamic model of TB transmission

### Model outline

The dynamic model of TB implemented here may be considered as 3 nested model these are: a TB transmission model; a demographic processes model; and a BCG vaccination model. For an overview of the model structure see the flow diagram (Figure \@ref(fig:model-flow-diag)) and for full details see the model equations (Section \@ref(model-equations)). Model parameters are discussed in detail in Section \@ref(model-parameters).

#### Disease model

The model includes the following compartments: Susceptible ($S$), high risk latent ($H$), low risk latent ($L$), active TB cases with pulmonary TB ($P$), active TB cases with extra-pulmonary TB disease only ($E$), pulmonary cases on treatment ($T_P$), and extra-pulmonary case on treatment ($T_E$). Cases that were previously infected and considered at low risk of developing active disease may be reinfected, although their latent infection provides partial protection. Treatment is assumed to be the only pathway to recovery for active TB disease, with a single rate used to model the heterogeneity of treatment times. A fraction of those on treatment are assumed to be lost to follow up, with these cases returned to active pulmonary or extra-pulmonary disease. Cases that start treatment immediately stop being infectious and upon treatment completion are treated as if they have low risk latent TB disease. TB mortality is included for both active TB cases on, and off, treatment. TB mortality is stratified by disease type and age. TB transmission is assumed to act under the mass action assumption.[@Anderson1991; @Keeling2007] Non-UK born cases are included into the force of infection.[@Anderson1991; @Keeling2007]


#### Demographic model

The model is stratified into 11 age groups with 5 year age groups from 0 to 49, a single age group from 50-69, and a single age group from 70 to 89. Older adults were grouped into larger age groups as they are thought to be responsible for a small amount of TB transmission and because fine scale BCG mechanisms do not need to be modelled in these age groups. Adults aged 90+ were not modeled due to large amounts of uncertainty in the demographic data and because cases in this population represent a small fraction of total TB cases (see Chapter \@ref(data)). The number of births in a given year is incorporated as a time varying parameter. The natural mortality rate is also allowed to vary with time and is stratified by age. Immigration and emigration were not included in the demographic model as reliable age stratified data were unavailable and it is unlikely that either immigration or emigration of the UK born population is a significant driver of overall population size, or structure.

#### Vaccination model

The vaccination model is nested into the demographic process model and therefore vaccination is possible upon entry to each modeled age group. The target age group can be varied to represent changing BCG vaccination policy. The vaccinated population is then modeled explicitly throughout all disease compartments. The primary action of the BCG vaccine is to prevent the transition from latent to active disease, this is included for both high and low risk latent cases. Waning vaccination effectiveness has been included by stratifying vaccine effectiveness by age group. The partial protection offered by BCG vaccination against initial infection has been included as a modifier on the protection from latent to active disease and as a modifier on the proportion of cases that are initially infected. This allows estimates of the effectiveness of BCG vaccination at preventing active TB disease in the susceptible population to be used, as these estimates have the most robust data sources. It is assumed that latently infected individuals do not gain additional protection from re-infection from the BCG vaccine. The BCG vaccine has been modeled as being partially protective for all individuals rather than as a "take" vaccine (i.e all or nothing protection). This assumption simplifies the model and will not impact the dynamics of TB transmission, assuming that protected and unprotected BCG vaccinated individuals obey the mass action assumption (See Chapter \@ref(introduction) and [@Anderson1991; @Keeling2007]).

\newpage 

```{r model-flow-diag, out.width = "400px", fig.scap = "Flow diagram for the dynamic TB disease model with demographics and vaccination described.", fig.cap = "Flow diagram for the dynamic TB disease model with demographics and vaccination described. The TB model contains the following compartments; Susceptible ($S$), high risk latent ($H$), low risk latent ($L$), active cases with pulmonary TB ($P$), active TB cases with extra-pulmonary TB only ($E$), pulmonary cases on treatment ($T_P$), and extra-pulmonary cases on treatment ($T_E$). The vaccinated ($v$) and unvaccinated ($u$) populations are represented by $k$, such that $k = u,v$. Age stratification is represented by $a$ (where $a = 1, 2, ...,11$) in the disease model and the $0,\ 1,\ 2,\ 3$ subscripts in the demographic model. Five year age groups are modelled (i.e $0-4$, $5-9$, $10-14$, ...) up to 49 years old, with a single age group for those aged 50-69 years old and those aged 70-89 years old. Individuals aged $90+$ are not explicitly modelled. In the demographic and vaccination model the A compartment represents the demographic processes modelled in all population compartments except for the vaccinated and unvaccinated susceptible populations. Solid arrows represent transition rates within the modelled populations and dashed arrows represent transition rates into, or out of the modelled populations (i.e birth and death processes).", out.extra = ""}
knitr::include_graphics(file.path(resources_path, "resources", "model_diagrams", "tb_model_flow.png"))
```

### Model equations {#model-equations}

In order to simplify the model equations the disease (d) and demographic and vaccination models (p) have been separated such that (where $C = S,\ H,\ L,\ P,\ E,\ T_P,\ T_E$), 

\begin{equation}
\frac{dC}{dt} =  \frac{dC^{d}}{dt} + \frac{dC^{p}}{dt} \\
  (\#eq:split-models)
\end{equation}

The disease model ($C^d$) is then defined as,

\begin{equation}
\frac{dS^{kd}_{a}}{dt} = - (1 - \chi^k_a)\lambda_a S^k_a 
  (\#eq:sus-model)
\end{equation}

\begin{equation}
\frac{dH^{kd}_{a}}{dt} = (1 - \chi^k_a)\lambda_a S^k_a + (1 - \delta)\lambda_a L^k_{a} - (1 - \alpha^k_a)\epsilon^a_H H^{k}_{a} - \kappa_a H^{k}_{a}
  (\#eq:high-model)
\end{equation}

\begin{equation}
\frac{dL^{kd}_{a}}{dt} =  \kappa_a H^{k}_{a} - (1 - \delta)\lambda_a L^k_{a} - (1 - \alpha^k_a) \epsilon^a_L L^{k}_{a} + \phi_a (T^{k}_{Pa} + T^{k}_{Ea})
  (\#eq:low-model)
\end{equation}

\begin{equation}
\frac{dP^{kd}_a}{dt} =  \Upsilon_a(1 - \alpha^k_a)(\epsilon^a_HH^{k}_{a}  + \epsilon^a_LL^{k}_{a}) + \zeta_a T^{k}_{Pa} - \nu_a^P P^{k}_a - \mu^P_a P^{k}_a
  (\#eq:pul-model)
\end{equation}

\begin{equation}
\frac{dE^{kd}_a}{dt} =  (1 - \Upsilon_a)(1 - \alpha^k_a)(\epsilon^a_HH^{k}_{a}  + \epsilon^a_LL^{k}_{a}) + \zeta_a T^{k}_{Ea} - \nu_a^E E^{k}_a - \mu^E_a E^{k}_a
  (\#eq:extra-pul-model)
\end{equation}

\begin{equation}
\frac{dT^{kd}_{Pa}}{dt} = \nu_a^P P^{k}_a - \zeta_a T^{k}_{Pa} - \mu^P_a T^{k}_{Pa} - \phi_a T^{k}_{Pa}
  (\#eq:pul-treat-model)
\end{equation}

\begin{equation}
\frac{dT^{kd}_{Ea}}{dt} = \nu_a^E E^{k}_a - \zeta_a T^{k}_{Ea} - \mu^E_a T^{k}_{Ea} - \phi_a T^{k}_{Ea}
  (\#eq:extra-pul-treat-model)
\end{equation}

Where the unvaccinated ($u$) and vaccinated ($v$) populations are represented by $k = u,v$ and age groups are represented by $a=0,1,2,3, ... 11$. The disease model parameters are defined as follows: $\lambda_a$ is the force of infection; $\epsilon_a$ is the rate of activation from each latent population; $\kappa_a$ is the rate of transition into the low risk latent population; $\nu_a$ is the rate of starting treatment; $\delta$ is the protection from re-infection conferred by prior latent infection; $\Upsilon_a$ is the proportion of cases that develop pulmonary TB, with or without extra-pulmonary TB; $\mu^{P,E}_a$ is the mortality from active pulmonary ($P$) and extra-pulmonary ($E$) TB; $\zeta_a$ is the rate of treatment failure; $\phi_a$ is the rate of successful treatment; $\alpha_a$ is the effectiveness of the BCG vaccine at preventing active TB disease; and $\chi^k_a$ is the protection inferred due to vaccination from initial infection. In the unvaccinated population $\alpha = 0$ and $\chi = 0$. Parameters with an $a$ subscript, or superscript, are age-stratified.

The demographic and vaccination model ($C^p$) is then defined as ($A = H,\ L,\ P,\ E,\ T_P,\ T_E$),

\begin{equation}
\frac{dS^{up}_{a}}{dt} = (1 - sgn(a)) (1 - \gamma_a)\omega(t) + sgn(a) (1 - \gamma_a)\theta_{a - 1} S^u_{a - 1} - \theta_a S^u_a -\mu_{a}(t) S^u_a
  (\#eq:sus-age-u-model)
\end{equation}

\begin{equation}
\frac{dS^{vp}_{a}}{dt} = (1 - sgn(a)) \gamma_a\omega(t) + sgn(a)\gamma_a\theta_{a - 1} S^u_{a - 1} - \theta_a S^v_a -\mu_{a}(t) S^v_a
  (\#eq:sus-age-v-model)
\end{equation}

\begin{equation}
\frac{dA^{kp}_{a}}{dt} = sgn(a)\theta_{a - 1} A^k_{a - 1} - \theta_a A^k_{a} - \mu_{a}(t) A^k_{a}
  (\#eq:other-age-model)
\end{equation}

Where $\omega(t)$ is the time varying number of births, $\gamma_a$ is the age-specific proportion that are vaccinated, $\theta_a$ is the rate of ageing, and $\mu_a(t)$ is the time varying natural mortality rate.

The signum function used above is defined as follows;
\begin{equation}
sgn(x) := \begin{cases}
0 & \text{if } x = 0, \\
1 & \text{if } x > 0. \end{cases}
  (\#eq:signum)
\end{equation}

Code for this model is available online.^[Model code: https://github.com/seabbs/ModelTBBCGEngland/blob/master/inst/bi/BaseLineModel.bi]
 
### Force of infection

The force of infection ($\lambda^k_a$) is the rate at which susceptible individuals are infected. Here it is defined using the law of mass action which assumes that infectious cases and susceptible cases randomly mix with the rate of mixing being determined by the fraction of the population that are susceptible, the transmission probability, and the contact rate.[@Anderson1991; @Keeling2007] It is age stratified ($a$, $A = \text{max}(a)$) by contact rates, by the proportion of cases that are smear positive in a given age group, by the transmission probability of each case, and by the rate of starting treatment. Stratification by vaccine status ($k$) is introduced by the number of current pulmonary TB cases. It can be defined as follows,

\begin{equation}
\lambda^k_a = \frac{\beta_a}{N} \sum\limits_{i=1}^{A} \rho_i C_{ai}\left(\frac{M_{a}\iota_i}{\nu_a^P} + \sum\limits_{j = u,v}P^j_i\right)
  (\#eq:force-of-infection)
\end{equation}


Where $\iota_a$ is the age stratified number of non-UK born pulmonary cases notified in a given year, $P^{u,v}_a$ is the number of vaccinated, and unvaccinated, pulmonary TB cases, $\rho_a$ is the age-specific proportion of cases that are smear positive, $\nu^P_a$ is the age-specific rate of starting treatment for active pulmonary TB, $C_{ai}$ is the age-stratified contact matrix (Section \@ref(contact-matrix)), $\beta_a$ is the age-stratified transmission probability, and $M_a$ is the age-stratified mixing rate between the UK born and non-UK born population. 

## Parameterisation and data synthesis

Parameters distributions were either estimated from the available data or assumed based on common values found in the literature. Where no comparable estimates were found in the literature a largely uninformative distribution has been used. The discussion of model parameters has been split into disease model parameters, vaccination model parameters, and demographic model parameters. The data sources used to estimate model parameters have been detailed although for the ETS and the LFS more detail is provided elsewhere (Chapter \@ref(data)).

### Data sources

#### Enhanced TB Surveillance System

Model parameters were estimated using the ETS system where possible, with data on all notified cases in England from Jan 1, 2000 to Dec 31, 2015. The ETS is a robust national surveillance network that collects demographic, clinical, and microbiological data; a yearly report is published detailing data collection, cleaning, and trends in TB incidence (Chapter \@ref(data)).[@PHE2017]

#### Labour Force Survey

Yearly population estimates, stratified by age and UK birth status, were extracted from the  April to June LFS from 2000 to 2015. As detailed previously (Chapter \@ref(data)) the LFS is a study of the employment circumstances of the UK population, providing the official measures of employment and unemployment in the UK. As the LFS is based on a sample the population estimates are subject to sampling errors.

### Model Parameters {#model-parameters}

#### Disease model parameters

Details of the prior distributions used for each disease model parameter are given in Table \@ref(tab:disease-model). Table \@ref(tab:sources-tab) contains details of the sources used to parameterise the model. More detail is given in the following sub-sections. 

```{r disease-model}
disease_params_table %>% 
  select(Parameter, Description, Distribution, Units, Method, Type) %>% 
kable(
  caption.short = "Dynamic disease model parameters, descriptions, prior distributions, units, method used to derive the prior distribution and the type.", 
  caption = "Dynamic disease model parameters, descriptions, prior distributions, units, method used to derive the prior distribution and the type (i.e data derived, literature, assumption). All data based parameters are included. P = pulmonary TB, E = extra-pulmonary TB, v = vaccinated, i = age at vaccination, $\\mathcal{U}$ = Uniform, $\\mathcal{N}$ = Normal", booktabs = TRUE, longtable = TRUE, escape = FALSE) %>% 
  kable_styling(font_size = 8, latex_options = c("repeat_header", "hold_position")) %>% 
  column_spec(c(5), width = "6cm") %>% 
  column_spec(c(2), width = "4cm") %>%
  column_spec(c(3), width = "6cm") %>%
  column_spec(c(1,4,6), width = "1.5cm") %>% 
  landscape()
```


```{r sources-tab}
## Gather all parameters and collapse into a relevant list.
params_and_sources <- disease_params_table %>% 
  bind_rows(demographic_params_table) %>% 
  nest(-Source) %>% 
  mutate(Source = Source %>% 
             str_remove("\\[") %>% 
             str_remove("\\]") %>% 
             str_split("; "),
           Source_1 = map_chr(Source, ~ .[1]),
           Source_2 = map_chr(Source, ~ .[2])) %>% 
  mutate_at(.vars = vars(Source_1, Source_2), str_trim) %>% 
  mutate_at(.vars = vars(Source_1, Source_2), ~ ifelse(str_detect(., "\\@"), paste0("[", ., "]"), .)) %>%
  select(-Source) %>% 
  gather(key = "key", value = "Source", Source_1, Source_2) %>% 
  select(-key) %>% 
  na.omit %>% 
  unnest(data) %>% 
  arrange(Parameter) %>% 
  group_by(Source) %>%
  summarise(Parameters = paste(Parameter, collapse = ", ")) %>% 
  arrange(desc(Source))

sources_table %>% 
  left_join(params_and_sources, by = "Source") %>% 
  select(Parameters, `Study Type`, Setting, Year, Description, Source) %>% 
  pander(caption = "(\\#tab:sources-tab) Sources used to parameterise the disease and demographic models. Parameters that use the source are given, as well as the study type, setting, year/years studied and a description of the study/data source.", split.cells = c(4, 10, 10, 8, 8, 50, 6), split.table = Inf)
```

##### Non-UK born pulmonary cases


Non-UK born pulmonary cases was estimated using the ETS for each age-group included in the model from 2000 until 2015. Prior to 2000, incidence in the non-UK born are unavailable and the relationship to transmission in UK-born cases is unknown. To account for this, importation of non-UK born cases in the model begins in 1960 and then is scaled up through to 2000. As the form of this relationship is unknown the following functional form was used to scale cases based on those observed in 2000,

\begin{equation}
\text{Non UK-born cases (time = t)} = \frac{\text{exp}\left(\frac{t - 1960}{\text{ln}(2) * (-1) * \iota_{\text{scale}}}\right) - 1}{\text{exp}\left(\frac{2000 - 1960}{\text{ln}(2) * (-1) * \iota_{\text{scale}}}\right) - 1} * \text{Non UK born cases (t = 2000)}
  (\#eq:non-uk-born-scale)
\end{equation}

This functional form was chosen as it is flexible enough to represent exponential growth, log constrained growth and near linear growth depending on the choice of $\iota_{\text{scale}}$. This allows the scale up of non-UK born cases to be fitted to the available data during the model fitting stage (Chapter \@ref(model-fitting)). To incorperate the uncertainty in the number of observed non-UK born cases a normal distribution was used, with the standard deviation and mean determined using parameters from the observation model (Chapter \@ref(model-fitting)).

##### Probability of transmission


The probability of transmission can be defined as the probability that a single contact between an infectious active TB case and a susceptible individual will lead to TB infection. The probability of transmission ($\beta_a$) can be redefined in terms of effective contacts (the transmission probability times the contact rate; $C_{\text{eff}}$), historic effective contacts ($C^{\text{hist}}_{\text{eff}}$), actual average yearly total contacts ($C_{\text{actual}}$), the average period of time infectious ($\frac{1}{\nu_{\text{avg}}^{P}}$), and the average mortality rate ($\mu_{\text{avg}}$) as follows,

\begin{equation}
\beta_a = \frac{(\nu_{\text{avg}}^{P} + \mu_{\text{avg}}) C^{\text{scaled}}_{\text{eff}}}{C_{\text{actual}}}
(\#eq:beta-eq)
\end{equation}

\begin{equation}
C^{\text{scaled}}_{\text{eff}} = \begin{cases}
C^{\text{hist}}_{\text{eff}} & \text{if } t < 1935, \\
C_{\text{eff}} + \left(C^{\text{hist}}_{\text{eff}} -  C_{\text{eff}} \right) \left(\frac{t-1935}{C^{\text{half-life}}_{\text{eff}}}\right)^{1/2} & \text{if } 1935 \leq t \leq 1980, \\
C_{\text{eff}} & \text{if } t > 1980. \end{cases}
  (\#eq:scaled-contacts)
\end{equation}

Vynnycky et al. found that the effective contact rate for TB was approximately 22 in 1900 and fell to approximately 1 in 1990.[@Vynnycky1999] Incidence rates have increased since the early 1980s and it is unclear what impact this has had on the effective contact rate. I have assumed that the effective contact rate is normally distributed with a mean of 1 and a standard deviation of 0.5. For the historic effective contact rate I have assumed a uniform distribution with a lower bound of the current effective contact rate and an upper bound of 20. I have also assumed that the historic contact rate declines over time, starting in 1935, reducing to the current effective contact rate in 1980. The speed of this decay is set by defining a half-life ($C^{\text{half-life}}_{\text{eff}}$). The prior for the half-life is assumed to be normally distributed with a mean of 5 years and a standard deviation of 5 (truncated to be greater than 0). This prior is based on the observed trend in notifications. Additional age stratification of $\beta$ is explored by including modifiers for certain age-groups. The baseline scenario is that no modification is required, with variation explored for young adults (15-29; $\beta_{\text{young adult}}$) as a scenario. The prior for this modifier was assumed to be uniform, bounded by 0 and 10. The contact rate is estimated by averaging the total age-specific contact rates estimated from POLYMOD data (Section \@ref(contact-matrix)) on an annual basis.

##### Rate of recovery from active disease


The rate of recovery from active TB disease was estimated as the reciprocal of the time with active, untreated, disease from the ETS with UK born cases from 2000 until 2012. Cases with a period of time symptomatic that was less than 0 days were removed as these are likely to be spurious. Figure \@ref(fig:tb-time-treat) indicates that the distribution of time to treatment differs between children and adults and by pulmonary/extra-pulmonary TB status. There was little evidence that time to treatment differed between adults and older adults. A normal distribution was used for each age group, truncated to be greater than 0 months. Prior to 1952, and the introduction of isoniazid, I have assumed that the time to recovery from active TB disease is 2 years, representing natural recovery or other removal from the infectious population. From 1952 to 1990 the time with active TB is assumed to decrease linearly. 

```{r tb-time-treat, fig.scap = "Distribution of time to treatment (days) from the date of reported symptom onset until the date started treatment for the UK born, stratified by age group and pulmonary/extra-pulmonary TB status in the ETS system for notifications between 2000 and 2012.", fig.cap = "Distribution of time to treatment (days) from the date of reported symptom onset until the date started treatment for the UK born, stratified by age group and pulmonary/extra-pulmonary TB status in the ETS system for notifications between 2000 and 2012. Age is stratified into three groups; children (0-14), adults (15-69) older adults (70-89). The time from symptom onset to starting treatment is shorter for cases with pulmonary TB cases across age groups, with younger cases starting treatment more rapidly than older cases. Vertical lines indicate the 2.5\\%, 25\\%, 50\\%, 75\\%, and 97.5\\% quantiles.", out.extra = ""}
knitr::include_graphics(file.path(resources_path, "resources", "figure", "time_to_treatment.png"))
```

##### Rate of successful treatment


The rate successful treatment was estimated as the reciprocal of the period of time on treatment using the ETS with UK born cases between 2000 and 2012. Cases with a treatment time less than 1 month were removed as TB treatment is standardised and should take at least several months. There was little evidence that time to treatment completion differed between pulmonary and extra-pulmonary TB cases but there was some evidence that older TB cases were more likely to be on treatment for longer than younger cases (Figure \@ref(fig:tb-treat-time-succ)). A normal distribution was used for children, adults and older adults, with each truncated to be greater than 4 months. This truncation was introduced as a faster treatment time than this was considered implausible.

```{r tb-treat-time-succ, fig.scap = "Distribution of time to treatment completion in the UK born successfully treated (days), stratified by age group and pulmonary/extra-pulmonary TB status in the ETS for notifications between 2000 and 2012.", fig.cap = "Distribution of time to treatment completion in the UK born successfully treated (days), stratified by age group and pulmonary/extra-pulmonary TB status in the ETS for notifications between 2000 and 2012. Age is stratified into three groups;children (0-14), adults (15-69) older adults (70-89). There is little evidence that the time to successful treatment differs between pulmonary and extra-pulmonary cases only but older cases appear to have a high likelihood of longer treatment times. Vertical lines indicate the 2.5\\%, 25\\%, 50\\%, 75\\%, and 97.5\\% quantiles.", out.extra = ""}
knitr::include_graphics(file.path(resources_path, "resources", "figure", "time_cure.png"))
```


##### Age-stratified contact matrix {#contact-matrix}


The previously defined age-stratified contact matrix has 72 free parameters, assuming that the contact matrix is symmetric. Whilst these parameters could conceivably be fitted to the available age-stratified incidence data it is likely that doing so would result in over-fitting and potentially obscure other age related differences. An alternative is to specify the contact matrix using available data sources. This is commonly achieved using survey data on the number of self reported contacts between individuals.[@Mossong2008] 

###### The POLYMOD contact survey


The POLYMOD survey,[@Mossong2008] which was conducted between May 2005 and September 2006, asked 7,290 participants across eight European countries (Belgium, Germany, Finland, Great Britain, Italy, Luxembourg, the Netherlands, and Poland) about the number of unique contacts on a randomly assigned day of the week. Survey participants were recruited to be broadly representative of the population in terms of geographical spread, age, and sex. Children and adolescents were deliberately over-sampled due to the important role they typically play in the transmission of infectious diseases. Contacts were defined as either physical (skin-to-skin contact) or as nonphysical (two-way conversation of 3 or more words in the presence of an individual but without physical contact). The age and gender of contacts was recorded as was the duration and location of the contact event. The locations were stratified into: home; school; work; transport; leisure; and other. In total 97,904 contacts were recorded, with both physical and nonphysical contacts showing large amounts of assortativity by age.

In the model presented here unstratified social (nonphysical) contacts are used to generate an age-stratified contact matrix. There are several reasons for this. Firstly, stratifying by home, school, work, transport or leisure contacts, whilst initially appealing as doing so may lead to insights as to the nature of the type of contacts required for TB transmission, may lead to over-fitting without a strong apriori hypothesis. In high and medium burden countries it has been shown that within household transmission is not a major driver of overall transmission.[@Mathema2018] Until recently it has been thought that household transmission plays a more dominated role in low burden settings, such as England, which would indicate that home contacts should be considered. However, it has recently been found that 7.7% (1849/24,060) of cases in England between 2010 and 2012 lived in a household with another case.[@Lalor2017] The same study estimated that overall only 3.9% of cases were due to recent household transmission, and there was no evidence that cases within households were more likely to transmit within the household than outside of it. There is little evidence to suggest that school, work, transport or leisure contacts are more likely to transmit TB in England than any other contact. The choice of contact type is disease dependent; for TB it is likely that closer contacts result in a greater likelihood of transmission.[@Mathema2018] Unfortunately the physical contacts recorded in the POLYMOD survey represent a poor proxy to closeness of contacts as physical contact can be a little as a handshake and because TB is a respiratory disease physical contact is not required. For this reason physical contacts have not been further evaluated. Instead, the uncertainty in age-dependent transmission rates has been explored by allowing for scenarios in which the transmission probability varies across age groups.

###### Generation of the symmetric contact matrix


As the POLYMOD contact data was collected using a survey there is likely to be measurement error and missing data for the number of contacts reported and the age that contacts were reported to be. Some participants also recorded contacts with an estimated age range rather than with a point estimate. In addition, as the survey had a relatively low sample size (1,011) in the UK, the estimated contact matrices contain considerable uncertainty. These considerations are often not considered in modelling studies but may introduce significant bias. Here the `socialmixr` R package^[`socialmixr`: https://github.com/sbfnk/socialmixr] is used to generate 1000 bootstrapped contact matrix samples using the following steps,


1. Missing or estimated ages are sampled from the appropriate ranges.

1. Using data on the participants of the POLYMOD study, and the contacts that they recorded, participants are randomly sampled (with replacement) and the mean number of contacts is then calculated from each age group (using 5 year age groups from 0-5 to 49, 50-69, and then 70+). 

1. Each sampled contact matrix is then averaged to be symmetric, as logically contacts should be mutual. This can be represented mathematically as follows,

\begin{equation} 
  C_{ij}N_i = C_{ji}N_j
  (\#eq:symmideal)
\end{equation} 

Where $N_i$ is the number of people in age group $i$, $N_j$ is the number of people in age group $j$, $C_{ij}$ is the number of contacts between members of group $i$ with group $j$ and $C_{ji}$ is the number of contacts between members of group $j$ with group $i$. In the POLYMOD survey this relationship does not hold exactly due to random variation. A symmetric contact matrix ($C^{\prime}_{ij}$) can be derived by averaging the contacts between the $i$ and $j$ groups and the $j$ and $i$ groups for all age groups using the following equation,

\begin{equation} 
  C^{\prime}_{ij} = \frac{C_{ij}N_i + C_{ji}N_j}{N_i + N_j}
  (\#eq:symmfull)
\end{equation} 


The above equation requires data on the population in which the survey was undertaken in order to create a symmetric contact matrix. Here we use the 2005 population of the UK as it is most representative of the POLYMOD study population.

This results in 1000 bootstrapped symmetric contact matrices based on the reported social contacts in the POLYMOD survey for the UK. In order to be used in the model the mean and standard deviation are calculated for the number of contacts between each age group, the data is also scaled to represent non-unique yearly contacts by multiplying by $365.25$. Contacts are then modelled noisily using a normal distribution around the mean number of contacts with the standard deviation as calculated above.

The final mean contact matrix is visualised in Figure \@ref(fig:contact-tile-plot), along with the normalised standard deviation. It is clear that the POLYMOD mixing is highly assortative with the majority of contacts occurring between those close to the same age.[@Mossong2008] The highest number of contacts were between children and young adults (between 5 and 20), with the number of within age groups contacts reducing as age increased. There was some outside age group mixing for all age groups with a large amount of mixing between children and middle aged adults (i.e parents and children). There was some uncertainty for all contact rates with the minimum normalised standard deviation being 10% of mean contact rates. Contact rates between older adults and children were highly uncertain and contact rates for older adults were also generally more uncertain.

\newpage

```{r contact-tile-plot, out.width = "250px", fig.scap = "a.) Mean contacts (non-unique social contacts per year) and the b.) normalised standard deviation (\\%) of 1000 boostrapped samples of social contacts from the POLYMOD social contact survey using 5 year age groups up 49 years old and then a single group for 50-69 year olds.", fig.cap = "a.) Mean contacts (non-unique social contacts per year) and the b.) normalised standard deviation (\\%) of 1000 boostrapped samples of  social contacts from the POLYMOD social contact survey using 5 year age groups up 49 years old and then a single group for 50-69 year olds. Mixing is highly assortative by age with children and young adults representing the majority of contacts. There is also evidence of mixing between children and middle age adults with older children mixing with progressivly older adults. Contact rates in older adults are highly uncertain, with the most uncertainty in mixing between older adults and young children."}
knitr::include_graphics(file.path(resources_path, "resources", "figure", "contact_matrix.png"))
```

\newpage

#### Vaccination model parameters


An overview of the vacination model parameters can be found in Table \@ref(tab:disease-model) for parameters that impact the natural history of TB, Table  \@ref(tab:demo-model-params) for parameters that impact the population level distribution of BCG vaccination, and Table \@ref(tab:sources-tab) for an overview of the sources used to generate prior distributions. More detail is given in the following section.

##### Effectiveness of the BCG vaccine at preventing active TB


The effectiveness of the BCG vaccine is usually estimated using its effectiveness at reducing the incidence of active TB cases in a susceptible population. In the model outlined in this chapter the action of the BCG vaccine has been split into its main effect of reducing the rate of latent TB cases developing active disease and its secondary effect of reducing the likelihood of initial infection. There are few estimates of the effectiveness of the BCG vaccine at preventing active TB in cases that are already latently infected and where these estimates do exist they are not stratified by time since vaccination, or age at vaccination.[@Roy2014] The overall effectiveness ($\alpha^T_a$) of the BCG vaccine can be estimated from the combined effectiveness at preventing initial infection ($\chi_a$) and then preventing activation in latently infected individuals ($\alpha_a$) using the following equation,

\begin{equation}
  \alpha^T_a = \chi_a + (1 - \chi_a) \alpha_a
  (\#eq:full-bcg-effectiveness)
\end{equation}

The effectiveness of the BCG vaccine at preventing active TB in those latently infected can then be found via rearrangement as follows,

\begin{equation}
  \alpha_a = \frac{\alpha^T_a - \chi_a}{1 - \chi_a}
  (\#eq:latent-active-bcg-effectiveness)
\end{equation}

There is strong evidence that the overall effectiveness of the BCG vaccine reduces over time.[@Abubakar2013; @Mangtani2017] For this reason the effectiveness of the BCG vaccination overall ($\alpha^T_a$) has been stratified by the time since vaccination (by 5 year age groups). This step-wise approach has been chosen as the majority of studies report estimates for these groups and the precise functional form of the reduction in protection is unknown. For 0-4, and 5-9, years since vaccination estimates of the effectiveness of the BCG vaccine were extracted from the MRC trial.[@Hart1972] Using the published data, Poisson regression was used to estimate Rate Ratios and 95% confidence intervals. For 10-29 years after vaccination Rate Ratio estimates from a more recent case control cohort study in the UK born vaccinated at school-age have been used.[@Mangtani2017] Table \@ref(tab:bcg-eff-est) details the estimated effectiveness for each five yearly band after initial vaccination. I have assumed that the BCG vaccine is equally effective regardless of when the vaccine is given as there is no evidence that protection reduces when given to older age groups in England. 

```{r bcg-eff-est}
kable(eff_bcg, booktabs = TRUE, escape = TRUE,
      caption.short = "Estimates of the effectiveness of the BCG vaccine at preventing active TB disease stratified by years since vaccination.", 
      caption = "Estimates of the effectiveness of the BCG vaccine at preventing active TB disease stratified by years since vaccination. For 0-9 years since vaccination estimates were derived using Poisson regression from the MRC BCG trial and for 10-29 years since vaccination estimates were extracted from a more recent case control cohort study in the UK born vaccinated at school-age. BCG effectiveness at preventing active TB disase used as prior distributions in the model.") %>% 
  kable_styling(latex_options = "hold_position")
```

Using the literature derived estimates for the Risk Ratio (RR) of the BCG vaccine at different periods after vaccination, the log normal approximation for the distribution of Risk Ratios, and the relationship between vaccination effectiveness and the Risk Ratio (Effectiveness = 1 - Risk Ratio) I derived a prior distribution for the overall effectiveness of the BCG vaccine ($\alpha^T_a$). This can be summarised by the following equation,

\begin{equation}
  \alpha^T_a = 1 - \text{exp}\left(\mathcal{N}(\text{ln}(RR_{t_v}, SE_{t_v})\right)
  (\#eq:rr-to-alpha)
\end{equation}

Where $RR_{t_v}$ is logged risk ratio and the $SE_{t_v}$ is the standard error of the logged Risk Ratio with both being dependent on the time since vaccination ($t_v$). The transformed values used as the prior distribution are detailed in Table \@ref(tab:disease-model).


##### Effectiveness of the BCG vaccine at preventing initial infection


Roy et al. published a meta-analysis that estimated the effectiveness of the BCG vaccine at preventing initial infection in children.[@Roy2014] This has been used as the primary source for this parameter, with the assumption being made that the effectiveness is the same in adults as it is in children. This is reasonable to assume as there is little evidence that the overall effectiveness of the BCG vaccines reduces with the age it is given in England. Unfortunately the meta-analysis by Roy et al. did not include an estimate of the effectiveness of the BCG vaccine at preventing initial TB infection stratified by time since vaccination. This is problematic as there is a large amount of evidence that the overall effectiveness of the BCG vaccine wanes with time,[@Abubakar2013; @Mangtani2017] and if the protection from initial infection does not also reduce over time then as overall effectiveness decreases the contribution from the prevention of initial infection will increase. For this reason I have assumed that the protection from initial infection ($\chi_j$) reduces over time with the same functional form as for the overall effectiveness of BCG vaccination ($\alpha^T_j$). This relation can be formalised using the following equation,

\begin{equation}
  \chi_j = \frac{\alpha^T_j\chi_i}{\alpha^T_i}
  (\#eq:fun-prev-initial-inf)
\end{equation}

Where $i$ is the age at vaccination and $j$ is any subsequent age group. 

#### Demographic model parameters {#demo-model-parameters}


The demographic model parameters are outlined in Table \@ref(tab:demo-model-params), additional details are given in the following section. Table \@ref(tab:sources-tab) contains details of the sources used to parameterise the demographic model, again more detail is given in the following section for complex parameters.

```{r demo-model-params, results = "asis"}
demographic_params_table %>% 
  select(Parameter, Description, Distribution, Units, Method, Type) %>% 
kable(
  caption.short = "Demographic model parameters, descriptions, prior distributions, units, method used to derive the prior distribution and the type.", 
  caption = "Demographic model parameters, descriptions, prior distributions, units, method used to derive the prior distribution and the type (i.e data derived, literature, assumption).  $\\mathcal{N}$ = Normal and i = age at vaccination.", booktabs = TRUE, longtable = TRUE, escape = FALSE) %>% 
  kable_styling(font_size = 8, latex_options = c("repeat_header", "hold_position")) %>% 
  column_spec(c(5), width = "6cm") %>% 
  column_spec(c(2), width = "4cm") %>%
  column_spec(c(3), width = "6cm") %>%
  column_spec(c(1,4,6), width = "1.5cm") %>% 
  landscape()
```

##### Age-stratified population estimates


Age-stratified and UK birth stratified population estimates for England were estimated using the LFS (Section \@ref(tb-inc-rates-epi)). Figure \@ref(fig:age-strat-demo) indicates that the age distribution of the UK born population changed over the study period (2000 to 2015) with an increase in those in late middle age (45-49 years old) and older and a decrease in those in early middle age. The proportion of young adults and young children also increased. This may have impacted TB incidence as young adults are thought to be responsible for the majority of transmission. Data from the 1931 census was also used to estimate the population of England in 1931 stratified into the modeled age groups.

```{r age-strat-demo, fig.scap = "Distribution of the UK born population of England in 2000, 2004, 2008, and 2012.", fig.cap = "Distribution of the UK born population of England in 2000, 2004, 2008, and 2012. Age is grouped into 5 year age groups from 0 to 49, from 50-69, and from 70 to 89. Those aged 90+ are excluded due to low quality data. The age groups used here represent those used in the model. The figure indicates that the population has skewed older overall over the last two decades, although the proportion of young children has increased in the last 10 years.", out.extra = ""}
knitr::include_graphics(file.path(resources_path, "resources", "figure", "england_demographics.png"))
```

##### Observed and projected births


The number of births is incorporated into the demographic model as a time varying, noisy, parameter ($\omega(t)$). It is parameterised from the data published by the Office for National Statistics (ONS), with the available data covering all years modeled. The ONS publishes the recorded number of births in England each year starting from 1929 through to 2015, with projections avaiable through to 2101 (Figure \@ref(fig:births-england)). As there is some uncertainty as to the number of births in each year I included normally distributed noise with a standard deviation of 5% of annual births.

```{r births-england, fig.scap = "Estimated and projected live births in England from 1929 until 2101.", fig.cap = "Estimated and projected live births in England from 1929 until 2101. The red line indicates estimated data and the blue line indicates projected data. Data is sourced from the ONS.", out.extra = ""}
knitr::include_graphics(file.path(resources_path, "resources", "figure", "births.png"))
```

##### Age-specific mortality rates


The time varying, age-specific, noisy, all-cause mortality rates ($\mu^{\text{all-cause}}_a(t)$) included in the demographic model are sourced from Office for National Statistics (ONS) estimates from 1981 until 2015. For years outside of the available data I forecast rates using an age-stratified exponential model (Figure \@ref(fig:mortality-england)). This model was used as it constrains mortality rates above zero and decreases yearly changes in mortality rates over time. To model the uncertainty in the estimate of the annual number of deaths a normally distributed noise term was introduced with a standard deviation of 5%. In order to calculate the all-cause dynamic mortality rate ($\mu_a(t)$), excluding deaths from, or related to, TB the following equation was used,

\begin{equation}
\mu_a(t) = \mu^{all-cause}_a(t) - \left(\frac{\mu^P_a(P_a + T_{Pa}) + \mu^E_a(E_a + T_{Ea})}{N_a}\right)
  (\#eq:adjusted-mortality)
\end{equation}

Where $\mu_a(t)$ is constrained to be greater than or equal to zero, $\mu^{P}_a$ and $\mu^E_a$ are the age stratified deaths rates in pulmonary ($P_a$) and extra-pulmonary TB cases ($E_a$), and $N_a$ is the age stratified population.

```{r mortality-england, fig.scap = "3 year rolling average expected remaining lifespan stratified by age group in England from 2000 to 2014.", fig.cap = "3 year rolling average expected remaining lifespan stratified by age group in England from 2000 to 2014. Age is grouped into 5 year age groups from 0 to 49, from 50-69, and from 70 to 89. Those aged 90+ are excluded due to low quality data. The age groups used here represent those used in the model. Data from this figure was sourced from the ONS age-specific mortality rate estimates with projections based on an age-stratified exponential model.", out.extra = ""}
knitr::include_graphics(file.path(resources_path, "resources", "figure", "mortality.png"))
```

## Initialisation

Dynamics transmission models are affected by the conditions under which they are initialised.[@Anderson1991]  For models of endemic disease this can be problematic as the full disease outbreak can often not be modeled, due to a lack of data and the changing nature of the endemic over time. A common approach to minimise this issue is to initialise the model with an uninformative set of initial conditions and then run the model for a period of time, known as the burn-in period, until steady state dynamics have developed.[@Anderson1991]  Models that include demographic processes are more complex to burn-in as demographic data is typically required to initialise the model so that it has the demographics observed during the period of time modeled.

### Starting simulation date, initial population and changes over time.

Model simulations are initiated in 1931 due to the availability of population data from the 1931 census and because data on live births is only available from 1929. The demographic model is initialised using the age grouped 1931 census data with the assumption that the entirety of the population is UK born. Initially it is assumed that there is no BCG vaccination and recovery from active TB takes 2 years. TB treatment is assumed to begin in 1952 with the discovery of isoniazid and BCG vaccination begins at school-age (15 years old) in 1953. BCG vaccination coverage is assumed to vary randomly over the time horizon of the model but to have the same distribution at all time points. The assumed distribution is normal with a mean of 75% and a standard deviation of 5%. The duration with active TB is assumed to decrease from the introduction of treatment in 1952 through to 1990 when it is assumed that detection rates were equivalent to those seen today. 

### Initial disease distribution

The model is initialised with the number of pulmonary and extra-pulmonary cases reported in 1931. The high risk latent population is initialised by scaling the number of observed cases in 1931 by the proportion of high risk latent cases that develop active TB, the duration that these cases are high risk and then dividing by the infectious period. The low risk latent population is then initialised by scaling the high risk latent population by the cumulative sum of the age distribution of UK born cases in 2000, reduced by 50% to account for mortality (approximately 5% of the population). Finally, the initial susceptible population is based on the population estimate from the 1931 census minus the assumed initial latent cases. 

All initial disease compartments, excepting the low risk latent compartment, are distributed based on the age distribution of observed UK born cases in 2000. To account for possible measurement error a normal distribution is sampled around the assumed population in each compartment with a standard deviation of 5% of the reported cases.

## Scenarios

All dynamic transmission models require a series of assumptions to be made. These assumptions fall into two categories: structural assumptions and parameter assumptions.[@Dowdy2012] Structural assumptions, such as the choice of serial latency in the model presented here, maybe difficult to test as they require the development of a parallel model structure. In the model presented here I have chosen to base the model structure on the known epidemiology of TB in England and the effects of the BCG vaccine. Structural assumptions have been discussed as have their potential impacts but a full scenario analysis of all potential model structures is beyond the scope of this work. Instead, I have focused on parameter assumptions which are more likely to directly impact the evaluation of BCG vaccination. 

During model fitting, I will consider the evidence for modifying the transmission probability, and non-UK born mixing, by age using three distinct scenarios (Table \@ref(tab:summary-scenarios)). These scenarios aim to test some of the key modelling assumptions made here. Identifying if the transmission probablity, or non-UK born mixing, varies with age is important as it may alter the distribution and number of TB cases. This would impact the observed effects of the BCG vaccine and is therefore of primary importance.

```{r summary-scenarios}
kable(scenarios_table, caption = "Summary of planned scenario analyses to be carried out in the next chapter as part of model fitting by comparision of the goodness of fit to the data.", booktabs = TRUE, escape = FALSE) %>% 
  column_spec(c(1), width = "4cm") %>% 
  column_spec(c(2), width = "8cm")
```

## Discussion

In this chapter, I have outlined the requirements for a dynamic transmission model of TB in order for it to be able to answer policy relevant questions relating to BCG vaccination in England. I then outlined, and gave the equations for, a semi-stochastic model that met these requirements and made best use of the data available. I defined prior distributions for each model parameter and initialisation conditions. I then detailed the data sources used for parameterisation, approximations required to make best use of the available data, and the scenario analyses needed to explore model, parameterisation and initialisation assumptions. 

This chapter has outlined a realistic dynamic transmission model of TB that includes the key features required to investigate BCG vaccination policy and is robustly parameterised from an extensive, and previously unused in a TB model, routine surveillance dataset. Transformations, and approximations, of parameters have been used to make the best use of available data. However, there are several key limitations. Firstly, the model presented here does not explicitly model TB transmission in the non-UK born. This means that in order to initialise the model assumptions must be made about the historic number of non-UK born cases and the future incidence in the non-UK born must also be assumed in order to produce projections of future TB incidence. However, this simplification allows many complexities of TB in the non-UK born to be discounted, such as the rate of case importation, heterogeneity amongst the non-UK born from different countries, and mixing within the non-UK born. Secondly, the model presented here does not include high and low risk stratification within the UK born. Individuals that are from countries with incidence above 40 per 100,000, or that have parents/grandparents from countries with incidence above 40 per 100,000, are considered at higher risk of TB.[@PublicHealthEngland2011a] In addition, individuals living in areas of the UK with incidence above this threshold are also considered at higher risk. Current BCG vaccination policy targets high risk neonates for vaccination, with low risk neonates not being vaccinated. Ideally, this high/low risk stratification would be included as it would allow the evaluation of the current BCG vaccination policy. This has not been possible as there is little data from which to extrapolate either the number of high risk notifications in the ETS,[@PHE2018] or the size of the high risk population. There is also little evidence to suggest the degree of mixing between the non-UK born, the high risk UK born population and the low risk non-UK born population. It is likely that introducing this structure into the model, without the data outlined above, would lead to the model being poorly specified and therefore failing to fit to the observed data. Instead, in the final chapter in this thesis, the high risk neonatal programme will be proxied by a universal neonatal programme. This will allow for a comparison to be made between school-age and neonatal vaccination but does not allow for the impact of targeting high risk individuals to be evaluated. Finally, the model presented here does not include the full complexity of TB epidemiology. Drug resistant TB may have more severe outcomes, standard TB treatment may fail resulting in a longer period on treatment, and TB outcomes may vary by risk group.[@PHE2017] However, drug resistant TB cases are known to make up a small fraction of TB cases in England in the UK born, and variable treatment times have been included in the prior distribution of treatment times and TB outcomes. Model parameters have also been stratified by pulmonary status and age group where appropriate. Additionally, complexity has been included for the action of the BCG vaccine, with realistic waning in effectiveness. Observed age-specific mortality rates and the number of live births has also been included, allowing for realistic population demographics. This means that estimates of the impact of the change in vaccination policy are likely to be more accurate, whereas a more complex model of the epidemiology of TB would likely have little impact on these results.

There are several key differences between the model presented here and others that have been previously been published that modeled TB transmission in low incidence settings or evaluated BCG vaccination policy. These are: the inclusion of dynamic TB transmission; robust parameterisation from an extensive surveillance dataset; realistic population demographics; and detailed modelling of the action of the BCG vaccine. Several previous studies have evaluated the role of BCG vaccination at a population level and estimated the impact of targeting different age groups and populations. Manissero et al. estimated the impact of various BCG vaccination strategies in low-intermediate incidence settings using an annual risk of infection model based on an approach previously published by Trunz et al. [@Manissero2008a; @Trunz2006] This approach estimates the number of new cases generated by a single smear positive case per year in a birth cohort. Only a single year of data was used to parameterise the model and age structure, the duration of protection from BCG vaccination and the different types of protection conferred by BCG vaccination were not considered. Rahman et al. compared the cost effectiveness of universal BCG vaccination to no vaccination using a cohort model of Japanese infants.[@Rahman2001a] Their model did not include TB transmission and used an estimated duration of protection from BCG of 10 years. Similarly Usher et al. used a decision analytical model to follow a birth cohort to compare universal, selective or no BCG vaccination.[@Usher2016] As in the previous study, TB transmission was not included. The model I have presented here includes TB transmission and uses more recent estimates of the effectiveness of the BCG vaccine to capture the full benefits of vaccination.

Several studies have made use of dynamic TB transmission models to evaluate BCG vaccination or future vaccines.[@Harris2016; @Egbetade2011a; @Bhunu2008b] In general, these studies used less detailed models than the one presented here, typically because they were modelling TB in a more generic setting or because more information about TB epidemiology, TB natural history, and the BCG vaccine has become available over time. In addition, no dynamic model of TB, including BCG vaccination, has currently been published that includes both protection from initial infection and protection from active TB due to BCG vaccination. There have also been no studies that use the current best estimates for the duration of BCG protection in developed countries away from the equator. Harris et al. reviewed mathematical models that explored the epidemiological impacts of future TB vaccines. They found that vaccines targeted at all-ages or at adolescents/adults were more effective at eradicating TB than neonatal programmes when vaccine effectiveness was not assumed to degrade with age. The majority of studies included in their review used deterministic, compartmental, dynamic models. Model structures were found to have evolved over time as TB natural history and epidemiology is better understood, with the majority of models having at least susceptible, latent, active disease, and recovered states. Treatment status, variable infectiousness of active disease, vaccine waning, and age stratification were included in some of the models evaluated.[@Harris2016] Recently it has been shown that only models that include at least two latent compartments are able to reproduce the observed activation dynamics of TB.[@Ragonnet2017] The model presented here is based on the serial latency archetype identified in this study. It has also been shown that realistic age structure and population demographics, included in the model presented in this chapter, are critical for reproducing TB epidemiology.[@Brooks-Pollock2010] Egbetade et al. presented a dynamic model of TB that included BCG vaccination but did not include age structure. They found that universal vaccination increased the stability of the disease free equilibrium in countries with high TB burden. However the model presented was not rigorously parameterised with data and only a single latent TB compartment was used.[@Egbetade2011a] Bhunu et al. developed a dynamic transmission model of TB that in order to investigate the effects of pre- and post-exposure vaccines for TB control. Again their model did not include multiple latent compartments or age structure unlike the model presented here.[@Bhunu2008b] 


Vynnycky et al. modeled the long term dynamics of pulmonary TB, in England and Wales, in the white male population using a deterministic TB transmission model that included; high and low risk latent periods, reinfection, BCG vaccination, TB specific and all-cause mortality.[@Vynnycky1997a] Whilst this is a highly detailed and well parameterised modelling study more recent developments such as survey derived age stratified contact matrices, evidence that BCG provides protection against initial infection as well as active TB disease and parameter estimates for TB activation stratified by age are included in the model presented here. In addition, their study only modeled TB transmission until 1990, allowing them to ignore the contribution of non-UK born cases. The model presented in this chapter includes non-UK born cases, via the force of infection, as they are now thought to be a key driver of TB transmission in England.

Dowdy et al. presented a data wish list for evidence base decision making using TB models, which may be used to assess the usefulness of a TB model for policy makers. The data requirements included: the rate of TB transmission; probability of developing active disease after an initial infection; the rate of activation amongst cases with risk factors; protection afforded by latent TB infection; the duration of infectiousness; treatment success; and the rate of spontaneous recovery. The model presented here fulfills the majority of these criteria. The rate of TB transmission is parameterised using previously published estimates of the effective contact rate in England,[@Vynnycky1999] this parameterisation will be refined in the following chapter using incidence data from the ETS. The probability of developing active TB has been sourced from recently published modelling work that fit a model of TB transmission to contact data in low incidence countries,[@Ragonnet2017] and is stratified by age as considered important by Dowdy et al. The rate of activation amongst cases with risk factors has not been included as it has been assumed that the proportion of UK born cases in the ETS with risk factors such as HIV is low. The duration of infectiousness, and treatment success have been parameterised using the ETS, although this approach is limited by possible reporting biases in the data available. The rate of spontaneous recovery has not been modeled as it is assumed that individuals are likely to be notified before clearing TB and are also likely to rapidly be started on TB treatment. This assumptions is likely to be valid as England has a robust national health service and a strong notification framework for TB. The protection afforded by latent TB infection has been included using the most recent literature sources available. All other parameters have been parameterised using the ETS where possible and otherwise from the most robust literature sources available. In particular the effectiveness of the BCG vaccine has been parameterised using data from studies that took place in England, where available, and both the protection from initial infection and the protection from developing active disease in those latently infected has been included along with estimates of the reduction in protection over time.

The semi-stochastic transmission dynamic model of TB transmission and BCG vaccination presented in this chapter provides a detailed overview of the features required to reproduce the observed epidemiology of TB in England. The model was robustly parameterised using routine surveillance data where available and otherwise using literature sources. The assumptions required by the model can be explored by fitting the model to observed data and assessing the goodness of fit. This is the focus of the next chapter. In addition the model may also be used to explore the impact of current and historic BCG vaccination policy, both in the observed data and projected into the future. This is explored in the final chapter of this thesis.


## Summary

- This chapter presents a semi-stochastic transmission dynamic model of TB transmission and BCG vaccination. The model includes; age structure, pulmonary and extra-pulmonary TB, re-infection and re-activation, serial latency, TB treatment, treatment failure, TB mortality, non-UK born cases and details of the historic TB endemic. Code for this model is available online.^[Model code: https://github.com/seabbs/ModelTBBCGEngland/blob/master/inst/bi/BaseLineModel.bi]

- The model has been robustly parameterised to a rich routine surveillance data set, which has allowed more complex features to be modeled than in previously published models. Parameter transformation and approximations, that make the best use of the available data, have been detailed.

- The assumptions required by the model have been explored in detail, with the required sensitivity analyses listed. These sensitivity analyses will be explored in the following chapter by comparing the goodness of fit of the model to the available data.

- The strengths and weaknesses of the model have been discussed as well as its context within the literature. It appears that few models are parameterised to a comparably rich surveillance data source, that few models capture the full complexity of BCG vaccination and that few models include realistic population demographics to the same extent as included in the model presented in this chapter.

- Chapter \@ref(sutherland) used a simple simulation model to estimate the impact of the 2005 change in BCG vaccination policy and Chapter \@ref(direct-eff) used Poisson and Negative Binomial multilevel models to estimate the observed impact of the change in policy on incidence rates in the directly effected populations. Whilst these approaches are valid they cannot estimate the indirect effects of policy changes, nor can they predict the future impacts of BCG vaccination policy. For this a transmission dynamic model, as presented here, is required. In the following chapter this model will be fit to available TB data and the impact of various BCG vaccination policies will be explored.
